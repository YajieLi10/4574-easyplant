WITH SESSION_ITEM_VIEW AS(
    SELECT SESSION_ID,
           COUNT(DISTINCT ITEM_NAME) AS NUM_VIEWED_ITEM,
           COUNT(DISTINCT CASE WHEN ADD_TO_CART_QUANTITY != 0 THEN ITEM_NAME ELSE NULL END) AS NUM_ADDED_TO_CART_ITEM,
           SUM(ADD_TO_CART_QUANTITY) AS TOTAL_NUM_ADD_TO_CART,
           SUM(REMOVE_FROM_CART_QUANTITY) AS TOTAL_NUM_REMOVE_FROM_CART,
           SUM(STAY_IN_CART_QUANTITY) AS TOTAL_NUM_STAY_IN_CART,
           SUM(ADD_TO_CART_QUANTITY * PRICE_PER_UNIT) AS TOTAL_PRICE_ADD_TO_CART,
           SUM(REMOVE_FROM_CART_QUANTITY * PRICE_PER_UNIT) AS TOTAL_PRICE_REMOVE_FROM_CART,
           SUM(STAY_IN_CART_QUANTITY * PRICE_PER_UNIT) AS TOTAL_PRICE_STAY_IN_CART,
    FROM {{ref('base_snowflake_web__item_views')}}
    GROUP BY SESSION_ID
),

SESSION_PAGE_VIEW AS(
    SELECT SESSION_ID,
           MAX(CASE WHEN PAGE_NAME = 'landing_page' THEN TRUE ELSE FALSE END)AS VISITED_LANDING_PAGE,
           MAX(CASE WHEN PAGE_NAME = 'plant_care' THEN TRUE ELSE FALSE END) AS VISITED_PLANT_CARE_PAGE,
           MAX(CASE WHEN PAGE_NAME = 'faq' THEN TRUE ELSE FALSE END) AS VISITED_FAQ_PAGE,
           MAX(CASE WHEN PAGE_NAME = 'shop_plants' THEN TRUE ELSE FALSE END) AS VISITED_SHOP_PLANTS_PAGE,
           MAX(CASE WHEN PAGE_NAME = 'cart' THEN TRUE ELSE FALSE END) AS VISITED_CART_PAGE,
    FROM {{ref('base_snowflake_web__page_views')}}
    GROUP BY SESSION_ID
)

SELECT s.SESSION_ID,
       s.SESSION_AT_TS,
       s.IP,
       s.OS,
       p.VISITED_LANDING_PAGE,
       p.VISITED_PLANT_CARE_PAGE,
       p.VISITED_FAQ_PAGE,
       p.VISITED_SHOP_PLANTS_PAGE,
       p.VISITED_CART_PAGE,
       COALESCE(i.NUM_VIEWED_ITEM,0) AS NUM_VIEWED_ITEM,
       COALESCE(i.NUM_ADDED_TO_CART_ITEM,0) AS NUM_ITEM_ADDED_TO_CART,
       COALESCE(i.TOTAL_NUM_ADD_TO_CART,0) AS TOTAL_NUM_ADD_TO_CART,
       COALESCE(i.TOTAL_NUM_REMOVE_FROM_CART,0) AS TOTAL_NUM_REMOVE_FROM_CART,
       COALESCE(i.TOTAL_NUM_STAY_IN_CART,0) AS TOTAL_NUM_STAY_IN_CART,
       COALESCE(i.TOTAL_PRICE_ADD_TO_CART,0) AS TOTAL_PRICE_ADD_TO_CART,
       COALESCE(i.TOTAL_PRICE_REMOVE_FROM_CART,0) AS TOTAL_PRICE_REMOVE_FROM_CART,
       COALESCE(i.TOTAL_PRICE_STAY_IN_CART,0) AS TOTAL_PRICE_STAY_IN_CART,
       CASE WHEN o.ORDER_ID IS NOT NULL THEN TRUE ELSE FALSE END AS CONVERTED_TO_ORDER
FROM {{ref('base_snowflake_web__sessions')}} AS s
LEFT JOIN SESSION_PAGE_VIEW AS p
ON s.SESSION_ID = p.SESSION_ID
LEFT JOIN SESSION_ITEM_VIEW AS i
ON s.SESSION_ID = i.SESSION_ID
LEFT JOIN {{ref('base_snowflake_web__orders')}} AS o
ON s.SESSION_ID = o.SESSION_ID
ORDER BY SESSION_AT_TS
